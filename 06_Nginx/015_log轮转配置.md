## log轮转配置

### 📄 方案：配置 Nginx 日志轮转（logrotate）——核心！

这是管理 `access.log` 和 `error.log` 的标准做法。

#### 步骤 1：创建 logrotate 配置文件

```bash
sudo vim /etc/logrotate.d/nginx-docker
```

写入以下内容（根据你的实际路径调整）：

```bash
/mnt/docker/nginx/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    copytruncate
    sharedscripts
    dateext
    postrotate
        # 如果 Nginx 是 Docker 容器，发送 USR1 信号重新打开日志
        docker kill -s USR1 nginx-container-name > /dev/null 2>&1 || true
    endscript
}
```

#### 参数说明：

| 参数                  | 作用                                                         |
| --------------------- | ------------------------------------------------------------ |
| `daily`               | 每天轮转一次                                                 |
| `rotate 7`            | 保留最近 7 个日志文件                                        |
| `compress`            | 轮转后用 gzip 压缩                                           |
| `copytruncate`        | **关键！** 先复制日志再清空原文件，避免 Nginx 因文件句柄丢失而无法写日志 |
| `postrotate ... USR1` | 通知 Nginx 重新打开日志文件（可选，增强可靠性）              |

> 💡 `copytruncate` 特别重要！因为 Docker 中 Nginx 无法直接 `kill -USR1` 主进程（权限问题），所以先清空文件最安全。

#### 步骤 2：测试 logrotate 配置

```bash
# 测试配置是否正确
logrotate -d /etc/logrotate.d/nginx-docker

# 强制执行一次（用于验证）
logrotate -f /etc/logrotate.d/nginx-docker
```

#### 步骤 3：系统自动运行

- `logrotate` 默认由 `cron` 每天执行一次（通常在 `/etc/cron.daily/logrotate`）
- 无需额外设置